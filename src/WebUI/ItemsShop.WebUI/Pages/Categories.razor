@page "/categories"
@inject ItemsShop.WebUI.Services.CatalogApiClient Api

<h1>Categories</h1>

<div class="card">
    <EditForm class="form-grid" Model="_search" OnValidSubmit="LoadCategoriesAsync">
        <div class="field">
            <label>Name</label>
            <InputText class="input" @bind-Value="_search.Name" placeholder="Search by name" />
        </div>
        <div class="field">
            <label>Order</label>
            <select class="input" @bind="_search.OrderType">
                <option value="">No order</option>
                <option value="Ascending">Ascending</option>
                <option value="Descending">Descending</option>
            </select>
        </div>
        <div class="field">
            <label>&nbsp;</label>
            <button class="btn btn-secondary" type="submit">Search</button>
        </div>
        <div class="field">
            <label>&nbsp;</label>
            <button class="btn" type="button" @onclick="(()=>{_search=new();})">Reset</button>
        </div>
    </EditForm>
</div>

<div class="card">
    <h3>Create Category</h3>
    <EditForm class="form-grid" Model="_create" OnValidSubmit="CreateAsync">
        <div class="field">
            <label>Name</label>
            <InputText class="input" @bind-Value="_create.Name" />
        </div>
        <div class="field">
            <label>Description</label>
            <InputText class="input" @bind-Value="_create.Description" />
        </div>
        <div class="field">
            <label>&nbsp;</label>
            <button class="btn btn-primary" type="submit">Create</button>
        </div>
    </EditForm>
    <p class="muted mt">@_status</p>
</div>

<table class="table mt">
    <thead>
        <tr>
            <th>Name</th>
            <th>Description</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var c in _categories)
        {
            <tr>
                <td>@c.Name</td>
                <td>@c.Description</td>
                <td><NavLink class="btn btn-secondary" href=@($"/categories/{c.Id}")>Open</NavLink></td>
            </tr>
        }
    </tbody>
    </table>

@code {
    private List<ItemsShop.WebUI.Models.Catalog.CategoryDto> _categories = new();
    private string _status = string.Empty;

    private SearchModel _search = new();
    private CreateModel _create = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
    }

    private async Task LoadCategoriesAsync()
    {
        _status = "Loading...";
        try
        {
            var items = await Api.GetCategoriesAsync(_search.Name, _search.OrderType);
            _categories = items.ToList();
            _status = $"Loaded {_categories.Count} categories";
        }
        catch (Exception ex)
        {
            _status = ex.Message;
        }
    }

    private async Task CreateAsync()
    {
        _status = "Creating...";
        try
        {
            await Api.CreateCategoryAsync(new(_create.Name ?? string.Empty, _create.Description));
            _create = new();
            await LoadCategoriesAsync();
            _status = "Created";
        }
        catch (Exception ex)
        {
            _status = ex.Message;
        }
    }

    private sealed class SearchModel
    {
        public string? Name { get; set; }
        public string? OrderType { get; set; }
    }

    private sealed class CreateModel
    {
        public string? Name { get; set; }
        public string? Description { get; set; }
    }
}


